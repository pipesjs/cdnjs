/* drawingboard.js v0.1.3 - https://github.com/Leimi/drawingboard.js
* Copyright (c) 2013 Emmanuel Pelletier
* Licensed MIT */
window.DrawingBoard={},DrawingBoard.Board=function(e,t){var n='<div class="drawing-board-controls"></div><div class="drawing-board-canvas-wrapper"><canvas class="drawing-board-canvas"></canvas><div class="drawing-board-cursor hidden"></div></div>';this.opts=$.extend({controls:["Color","Size","Navigation"],background:"#ffffff",localStorage:!1,color:"#000000",size:3,droppable:!0},t),this.ev=new DrawingBoard.Utils.MicroEvent,this.id=e,this.$el=$(document.getElementById(e));if(!this.$el.length)return!1;this.resizeContainer=this.$el.get(0).tagName.toLowerCase()=="canvas";if(this.resizeContainer){var r=this.$el.get(0).outerHTML.replace(/^<canvas/,"<div").replace(/<\/canvas>$/,"</div>");this.$el=$(r).replaceAll(this.$el)}this.$el.addClass("drawing-board").append(n),this.dom={$canvasWrapper:this.$el.find(".drawing-board-canvas-wrapper"),$canvas:this.$el.find(".drawing-board-canvas"),$cursor:this.$el.find(".drawing-board-cursor"),$controls:this.$el.find(".drawing-board-controls")},this.canvas=this.dom.$canvas.get(0),this.ctx=this.canvas.getContext("2d"),this.reset({localStorage:!1,resize:!1}),this.initControls(),this.reset({localStorage:!1}),this.restoreLocalStorage(),this.initDropEvents(),this.initDrawEvents()},DrawingBoard.Board.prototype={reset:function(e){e=$.extend({background:this.opts.background,color:this.opts.color,size:this.opts.size,localStorage:!0,resize:!0},e);var t=e.background.charAt(0)=="#"&&(e.background.length==7||e.background.length==4)||e.background.substring(0,3)=="rgb";if(e.resize){this.dom.$controls.toggleClass("drawing-board-controls-hidden",!this.controls||!this.controls.length);var n,r,i=[this.$el.width(),DrawingBoard.Utils.boxBorderWidth(this.$el),DrawingBoard.Utils.boxBorderWidth(this.dom.$canvasWrapper,!0,!0)],s=[this.$el.height(),DrawingBoard.Utils.boxBorderHeight(this.$el),this.dom.$controls.height(),DrawingBoard.Utils.boxBorderHeight(this.dom.$controls,!1,!0),DrawingBoard.Utils.boxBorderHeight(this.dom.$canvasWrapper,!0,!0)],o=this,u=function(e,t){t=t||1;var n=e[0];for(var r=1;r<e.length;r++)n+=e[r]*t;return n},a=function(e){return u(e,-1)};this.resizeContainer?(n=this.$el.width(),r=this.$el.height(),this.$el.width(u(i)),this.$el.height(u(s))):(n=a(i),r=a(s)),this.dom.$canvasWrapper.css("width",n+"px"),this.dom.$canvasWrapper.css("height",r+"px"),this.canvas.width=n,this.canvas.height=r}this.ctx.strokeStyle=e.color,this.ctx.lineWidth=e.size,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.save(),t&&(this.ctx.fillStyle=e.background),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore(),t||this.setImg(this.opts.background),e.localStorage&&this.saveLocalStorage(),this.ev.trigger("board:reset",e)},initControls:function(){this.controls=[];if(!this.opts.controls.length)return!1;for(var e=0;e<this.opts.controls.length;e++){var t=null;if(typeof this.opts.controls[e]=="string")t=new window.DrawingBoard.Control[this.opts.controls[e]](this);else if(typeof this.opts.controls[e]=="object"){for(var n in this.opts.controls[e])break;t=new window.DrawingBoard.Control[n](this,this.opts.controls[e][n])}t&&this.addControl(t)}},addControl:function(e,t,n){if(typeof e!="string"&&(typeof e!="object"||!e instanceof DrawingBoard.Control))return!1;var r=typeof t=="object"?t:{};n=n?n*1:typeof t=="number"?t:null,typeof e=="string"&&(e=new window.DrawingBoard.Control[e](this,r)),n?this.dom.$controls.children().eq(n).before(e.$el):this.dom.$controls.append(e.$el),this.controls||(this.controls=[]),this.controls.push(e),this.dom.$controls.removeClass("drawing-board-controls-hidden")},setImg:function(e){img=new Image,img.onload=$.proxy(function(){this.ctx.drawImage(img,0,0)},this),img.src=e},getImg:function(){return this.canvas.toDataURL("image/png")},downloadImg:function(){var e=this.getImg();e=e.replace("image/png","image/octet-stream"),window.location.href=e},restoreLocalStorage:function(){this.opts.localStorage&&window.localStorage&&localStorage.getItem("drawing-board-image-"+this.id)!==null&&(this.setImg(localStorage.getItem("drawing-board-image-"+this.id)),this.ev.trigger("board:restoreLocalStorage",localStorage.getItem("drawing-board-image-"+this.id)))},saveLocalStorage:function(){this.opts.localStorage&&window.localStorage&&(localStorage.setItem("drawing-board-image-"+this.id,this.getImg()),this.ev.trigger("board:saveLocalStorage",this.getImg()))},initDropEvents:function(){if(!this.opts.droppable)return!1;this.dom.$canvas.on("dragover dragenter drop",function(e){e.stopPropagation(),e.preventDefault()}),this.dom.$canvas.on("drop",$.proxy(this._onCanvasDrop,this))},_onCanvasDrop:function(e){e=e.originalEvent?e.originalEvent:e;var t=e.dataTransfer.files;if(!t||!t.length||t[0].type.indexOf("image")==-1||!window.FileReader)return!1;var n=new FileReader;n.readAsDataURL(t[0]),n.onload=$.proxy(function(e){this.setImg(e.target.result),this.ev.trigger("board:imageDropped",e.target.result),this.ev.trigger("board:userAction")},this)},initDrawEvents:function(){this.isDrawing=!1,this.isMouseHovering=!1,this.coords={},this.coords.old=this.coords.current=this.coords.oldMid={x:0,y:0},this.dom.$canvas.on("mousedown touchstart",$.proxy(function(e){this._onInputStart(e,this._getInputCoords(e))},this)),this.dom.$canvas.on("mousemove touchmove",$.proxy(function(e){this._onInputMove(e,this._getInputCoords(e))},this)),this.dom.$canvas.on("mousemove",$.proxy(function(e){},this)),this.dom.$canvas.on("mouseup touchend",$.proxy(function(e){this._onInputStop(e,this._getInputCoords(e))},this)),this.dom.$canvas.on("mouseover",$.proxy(function(e){this._onMouseOver(e,this._getInputCoords(e))},this)),this.dom.$canvas.on("mouseout",$.proxy(function(e){this._onMouseOut(e,this._getInputCoords(e))},this)),requestAnimationFrame($.proxy(this.draw,this))},draw:function(){if(this.ctx.lineWidth>10&&this.isMouseHovering){this.dom.$cursor.css({width:this.ctx.lineWidth+"px",height:this.ctx.lineWidth+"px"});var e=DrawingBoard.Utils.tpl("translateX({{x}}px) translateY({{y}}px)",{x:this.coords.current.x-this.ctx.lineWidth/2,y:this.coords.current.y-this.ctx.lineWidth/2});this.dom.$cursor.css({transform:e,"-webkit-transform":e,"-ms-transform":e}),this.dom.$cursor.removeClass("drawing-board-utils-hidden")}else this.dom.$cursor.addClass("drawing-board-utils-hidden");if(this.isDrawing){var t=this._getMidInputCoords(this.coords.current);this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.quadraticCurveTo(this.coords.old.x,this.coords.old.y,this.coords.oldMid.x,this.coords.oldMid.y),this.ctx.stroke(),this.coords.old=this.coords.current,this.coords.oldMid=t}requestAnimationFrame($.proxy(function(){this.draw()},this))},_onInputStart:function(e,t){this.coords.current=this.coords.old=t,this.coords.oldMid=this._getMidInputCoords(t),this.isDrawing=!0,this.ev.trigger("board:startDrawing",{e:e,coords:t}),e.preventDefault()},_onInputMove:function(e,t){this.coords.current=t,this.ev.trigger("board:drawing",{e:e,coords:t}),e.preventDefault()},_onInputStop:function(e,t){this.isDrawing&&(!e.touches||e.touches.length===0)&&(this.isDrawing=!1,this.saveLocalStorage(),this.ev.trigger("board:stopDrawing",{e:e,coords:t}),this.ev.trigger("board:userAction"),e.preventDefault())},_onMouseOver:function(e,t){this.isMouseHovering=!0,this.coords.old=this._getInputCoords(e),this.coords.oldMid=this._getMidInputCoords(this.coords.old),e.which!==1&&(this.isDrawing=!1),this.ev.trigger("board:mouseOver",{e:e,coords:t})},_onMouseOut:function(e,t){this.isMouseHovering=!1,this.ev.trigger("board:mouseOut",{e:e,coords:t})},_getInputCoords:function(e){e=e.originalEvent?e.originalEvent:e;var t,n;return e.touches&&e.touches.length==1?(t=e.touches[0].pageX,n=e.touches[0].pageY):(t=e.pageX,n=e.pageY),{x:t-this.dom.$canvas.offset().left,y:n-this.dom.$canvas.offset().top}},_getMidInputCoords:function(e){return{x:this.coords.old.x+e.x>>1,y:this.coords.old.y+e.y>>1}}},DrawingBoard.Utils={},DrawingBoard.Utils.tpl=function(){"use strict";var e="{{",t="}}",n="[a-z0-9_][\\.a-z0-9_]*",r=new RegExp(e+"\\s*("+n+")\\s*"+t,"gi"),i;return function(e,t){return e.replace(r,function(e,n){var r=n.split("."),s=r.length,o=t,u=0;for(;u<s;u++){o=o[r[u]];if(o===i)throw"tim: '"+r[u]+"' not found in "+e;if(u===s-1)return o}})}}(),DrawingBoard.Utils.MicroEvent=function(){},DrawingBoard.Utils.MicroEvent.prototype={bind:function(e,t){this._events=this._events||{},this._events[e]=this._events[e]||[],this._events[e].push(t)},unbind:function(e,t){this._events=this._events||{};if(e in this._events==0)return;this._events[e].splice(this._events[e].indexOf(t),1)},trigger:function(e){this._events=this._events||{};if(e in this._events==0)return;for(var t=0;t<this._events[e].length;t++)this._events[e][t].apply(this,Array.prototype.slice.call(arguments,1))}},DrawingBoard.Utils._boxBorderSize=function(e,t,n,r){t=!!t||!0,n=!!n||!1;var i=0,s;r=="width"?(s=["border-left-width","border-right-width"],t&&s.push("padding-left","padding-right"),n&&s.push("margin-left","margin-right")):(s=["border-top-width","border-bottom-width"],t&&s.push("padding-top","padding-bottom"),n&&s.push("margin-top","margin-bottom"));for(var o=s.length-1;o>=0;o--)i+=parseInt(e.css(s[o]).replace("px",""),10);return i},DrawingBoard.Utils.boxBorderWidth=function(e,t,n){return DrawingBoard.Utils._boxBorderSize(e,t,n,"width")},DrawingBoard.Utils.boxBorderHeight=function(e,t,n){return DrawingBoard.Utils._boxBorderSize(e,t,n,"height")},function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();