!function(e){if("function"==typeof require&&"undefined"!=typeof module){var r=require("sockjs-client");if(!r)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");e(r)}else if("function"==typeof define&&define.amd)define("vertx-eventbus",["sockjs"],e);else{if(void 0===this.SockJS)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");EventBus=e(this.SockJS)}}(function(e){function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e,r){return r=16*Math.random(),("y"==e?3&r|8:0|r).toString(16)})}function n(e,r){if(e){if(!r)return e;for(var n in e)e.hasOwnProperty(n)&&void 0===r[n]&&(r[n]=e[n])}return r||{}}var s=function(r,n){var t=this;n=n||{},this.pingInterval=n.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.sockJSConn=new e(r,null,n),this.state=s.CONNECTING,this.handlers={},this.replyHandlers={},this.defaultHeaders=null,this.onerror=function(e){try{console.error(e)}catch(e){}},this.sockJSConn.onopen=function(){t.pingEnabled(!0),t.state=s.OPEN,t.onopen&&t.onopen()},this.sockJSConn.onclose=function(e){t.state=s.CLOSED,t.pingTimerID&&clearInterval(t.pingTimerID),t.onclose&&t.onclose(e)},this.sockJSConn.onmessage=function(e){var r=JSON.parse(e.data);if(r.replyAddress&&Object.defineProperty(r,"reply",{value:function(e,n,s){t.send(r.replyAddress,e,n,s)}}),t.handlers[r.address])for(var n=t.handlers[r.address],s=0;s<n.length;s++)"err"===r.type?n[s]({failureCode:r.failureCode,failureType:r.failureType,message:r.message}):n[s](null,r);else if(t.replyHandlers[r.address]){var i=t.replyHandlers[r.address];delete t.replyHandlers[r.address],"err"===r.type?i({failureCode:r.failureCode,failureType:r.failureType,message:r.message}):i(null,r)}else if("err"===r.type)t.onerror(r);else try{console.warn("No handler found for message: ",r)}catch(e){}}};if(s.prototype.send=function(e,t,i,o){if(this.state!=s.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof i&&(o=i,i={});var a={type:"send",address:e,headers:n(this.defaultHeaders,i),body:t};if(o){var d=r();a.replyAddress=d,this.replyHandlers[d]=o}this.sockJSConn.send(JSON.stringify(a))},s.prototype.publish=function(e,r,t){if(this.state!=s.OPEN)throw new Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:e,headers:n(this.defaultHeaders,t),body:r}))},s.prototype.registerHandler=function(e,r,t){if(this.state!=s.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof r&&(t=r,r={}),this.handlers[e]||(this.handlers[e]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:e,headers:n(this.defaultHeaders,r)}))),this.handlers[e].push(t)},s.prototype.unregisterHandler=function(e,r,t){if(this.state!=s.OPEN)throw new Error("INVALID_STATE_ERR");var i=this.handlers[e];if(i){"function"==typeof r&&(t=r,r={});var o=i.indexOf(t);-1!=o&&(i.splice(o,1),0===i.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:e,headers:n(this.defaultHeaders,r)})),delete this.handlers[e]))}},s.prototype.close=function(){this.state=s.CLOSING,this.sockJSConn.close()},s.CONNECTING=0,s.OPEN=1,s.CLOSING=2,s.CLOSED=3,s.prototype.pingEnabled=function(e){var r=this;if(e){var n=function(){r.sockJSConn.send(JSON.stringify({type:"ping"}))};r.pingInterval>0&&(n(),r.pingTimerID=setInterval(n,r.pingInterval))}else r.pingTimerID&&(clearInterval(r.pingTimerID),r.pingTimerID=null)},"undefined"==typeof exports)return s;"undefined"!=typeof module&&module.exports?exports=module.exports=s:exports.EventBus=s});