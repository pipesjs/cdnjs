var convnetjs=function(t){function s(t,s){return Math.floor(Math.random()*(s-t)+t)}function i(t,s){return t+e()*s}function e(){var t=2*Math.random()-1,s=2*Math.random()-1,i=t*t+s*s;if(0==i||i>1)return e();var h=Math.sqrt(-2*Math.log(i)/i);return t*h}function h(t){if("undefined"==typeof t||isNaN(t))return[];for(var s=new Array(t),i=0;i<t;i++)s[i]=0;return s}function r(t,i,e){if("undefined"==typeof e)var e=!1;var h;if(i<t.sx){h=new a(i,i,t.depth,0);for(var r=s(0,t.sx-i),o=s(0,t.sy-i),n=0;n<i;n++)for(var u=0;u<i;u++)for(var _=0;_<t.depth;_++)h.set(n,u,_,t.get(n+r,u+o,_))}else h=t;if(e){for(var d=h.cloneAndZero(),n=0;n<h.sx;n++)for(var u=0;u<h.sy;u++)for(var _=0;_<h.depth;_++)d.set(n,u,_,h.get(h.sx-n-1,u,_));h=d}return h}function o(t,s){if("undefined"==typeof s)var s=!1;var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var e=i.getContext("2d");try{e.drawImage(t,0,0)}catch(t){if("NS_ERROR_NOT_AVAILABLE"===t.name)return!1;throw t}try{var h=e.getImageData(0,0,i.width,i.height)}catch(t){if("IndexSizeError"===t.name)return!1;throw t}for(var r=h.data,o=t.width,n=t.height,u=[],_=0;_<r.length;_++)u.push(r[_]/255-.5);var d=new a(o,n,4,0);if(d.w=u,s){for(var p=new a(o,n,1,0),_=0;_<o;_++)for(var f=0;f<n;f++)p.set(_,f,0,d.get(_,f,0));d=p}return d}var a=function(t,s,e,h){if(this.sx=t,this.sy=s,this.depth=e,"undefined"==typeof h){this.w=[],this.dw=[];for(var r=Math.sqrt(1/(t*s*e)),o=0;o<t*s*e;o++)this.w.push(i(0,r)),this.dw.push(0)}else{this.w=[],this.dw=[];for(var o=0;o<t*s*e;o++)this.w.push(h),this.dw.push(0)}};a.prototype={get:function(t,s,i){var e=(this.sx*s+t)*this.depth+i;return this.w[e]},set:function(t,s,i,e){var h=(this.sx*s+t)*this.depth+i;this.w[h]=e},add:function(t,s,i,e){this.w[(this.sx*s+t)*this.depth+i]+=e},get_grad:function(t,s,i){return this.dw[(this.sx*s+t)*this.depth+i]},set_grad:function(t,s,i,e){this.dw[(this.sx*s+t)*this.depth+i]=e},add_grad:function(t,s,i,e){this.dw[(this.sx*s+t)*this.depth+i]+=e},cloneAndZero:function(){return new a(this.sx,this.sy,this.depth,0)},clone:function(){for(var t=new a(this.sx,this.sy,this.depth,0),s=0;s<this.w.length;s++)t.w[s]=this.w[s];return t},addFrom:function(t){for(var s=0;s<this.w.length;s++)this.w[s]+=t.w[s]},addFromScaled:function(t,s){for(var i=0;i<this.w.length;i++)this.w[i]+=s*t.w[i]},setConst:function(t){for(var s=0;s<this.w.length;s++)this.w[s]=t},toJSON:function(){var t={};return t.sx=this.sx,t.sy=this.sy,t.depth=this.depth,t.w=this.w,t},fromJSON:function(t){this.sx=t.sx,this.sy=t.sy,this.depth=t.depth,this.w=t.w,this.dw=h(this.w.length)}};var n=function(t){var t=t||{};this.out_depth=t.filters,this.sx=t.sx,this.in_depth=t.in_depth,this.in_sx=t.in_sx,this.in_sy=t.in_sy,this.sy="undefined"!=typeof t.sy?t.sy:this.sx,this.stride="undefined"!=typeof t.sy?t.stride:1,this.decay_mul="undefined"!=typeof t.decay_mul?t.decay_mul:1,this.out_sx=Math.floor(this.in_sx/this.stride),this.out_sy=Math.floor(this.in_sy/this.stride),this.layer_type="conv",this.filters=[];for(var s=0;s<this.out_depth;s++)this.filters.push(new a(this.sx,this.sy,this.in_depth));this.biases=new a(1,1,this.out_depth,.1)};n.prototype={forward:function(t,s){this.in_act=t;for(var i=new a(this.out_sx,this.out_sy,this.out_depth,0),e=Math.floor(this.sx/2),h=Math.floor(this.sy/2),r=0;r<this.out_depth;r++)for(var o=this.filters[r],n=0,u=0,_=0;_<t.sx;_+=this.stride,n++){u=0;for(var d=0;d<t.sy;d+=this.stride,u++){for(var p=0,f=0;f<o.sx;f++)for(var y=0;y<o.sy;y++)for(var l=0;l<o.depth;l++){var c=d+y-h,w=_+f-e;c>=0&&c<t.sy&&w>=0&&w<t.sx&&(p+=o.w[(o.sx*y+f)*o.depth+l]*t.w[(t.sx*c+w)*t.depth+l])}p+=this.biases.w[r],i.set(n,u,r,p)}}return this.out_act=i,this.out_act},backward:function(){var t=this.in_act;t.dw=h(t.w.length);for(var s=Math.floor(this.sx/2),i=Math.floor(this.sy/2),e=0;e<this.out_depth;e++)for(var r=this.filters[e],o=0,a=0,n=0;n<t.sx;n+=this.stride,o++){a=0;for(var u=0;u<t.sy;u+=this.stride,a++){for(var _=this.out_act.get_grad(o,a,e),d=0;d<r.sx;d++)for(var p=0;p<r.sy;p++)for(var f=0;f<r.depth;f++){var y=u+p-i,l=n+d-s;y>=0&&y<t.sy&&l>=0&&l<t.sx&&(r.dw[(r.sx*p+d)*r.depth+f]+=t.w[(t.sx*y+l)*t.depth+f]*_,t.dw[(t.sx*y+l)*t.depth+f]+=r.w[(r.sx*p+d)*r.depth+f]*_)}this.biases.dw[e]+=_}}},getParamsAndGrads:function(){for(var t=[],s=0;s<this.out_depth;s++)t.push({params:this.filters[s].w,grads:this.filters[s].dw,decay_mul:this.decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,decay_mul:0}),t},toJSON:function(){var t={};t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.in_depth=this.in_depth,t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.decay_mul=this.decay_mul,t.filters=[];for(var s=0;s<this.filters.length;s++)t.filters.push(this.filters[s].toJSON());return t.biases=this.biases.toJSON(),t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.sx=t.sx,this.sy=t.sy,this.stride=t.stride,this.in_depth=t.in_depth,this.filters=[],this.decay_mul="undefined"!=typeof t.decay_mul?t.decay_mul:1;for(var s=0;s<t.filters.length;s++){var i=new a(0,0,0,0);i.fromJSON(t.filters[s]),this.filters.push(i)}this.biases=new a(0,0,0,0),this.biases.fromJSON(t.biases)}};var u=function(t){var t=t||{};this.sx=t.sx,this.in_depth=t.in_depth,this.in_sx=t.in_sx,this.in_sy=t.in_sy,this.sy="undefined"!=typeof t.sy?t.sy:this.sx,this.stride="undefined"!=typeof t.sy?t.stride:2,this.out_depth=this.in_depth,this.out_sx=Math.floor(this.in_sx/this.stride),this.out_sy=Math.floor(this.in_sy/this.stride),this.layer_type="pool",this.switchx=h(this.out_sx*this.out_sy*this.out_depth),this.switchy=h(this.out_sx*this.out_sy*this.out_depth)};u.prototype={forward:function(t,s){this.in_act=t;for(var i=new a(this.out_sx,this.out_sy,this.out_depth,0),e=Math.floor(this.sx/2),h=Math.floor(this.sy/2),r=0,o=0;o<this.out_depth;o++)for(var n=0,u=0,_=0;_<t.sx;_+=this.stride,n++){u=0;for(var d=0;d<t.sy;d+=this.stride,u++){for(var p=-99999,f=-1,y=-1,l=0;l<this.sx;l++)for(var c=0;c<this.sy;c++){var w=d+c-h,v=_+l-e;if(w>=0&&w<t.sy&&v>=0&&v<t.sx){var m=t.get(v,w,o);m>p&&(p=m,f=v,y=w)}}this.switchx[r]=f,this.switchy[r]=y,r++,i.set(n,u,o,p)}}return this.out_act=i,this.out_act},backward:function(){var t=this.in_act;t.dw=h(t.w.length);for(var s=(this.out_act,Math.floor(this.sx/2),Math.floor(this.sy/2),0),i=0;i<this.out_depth;i++)for(var e=0,r=0,o=0;o<t.sx;o+=this.stride,e++){r=0;for(var a=0;a<t.sy;a+=this.stride,r++){var n=this.out_act.get_grad(e,r,i);t.add_grad(this.switchx[s],this.switchy[s],i,n),s++}}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.in_depth=this.in_depth,t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.sx=t.sx,this.sy=t.sy,this.stride=t.stride,this.in_depth=t.in_depth}};var _=function(t){var t=t||{};this.out_depth="undefined"!=typeof t.num_neurons?t.num_neurons:t.filters,this.decay_mul="undefined"!=typeof t.decay_mul?t.decay_mul:1,this.num_inputs=t.in_sx*t.in_sy*t.in_depth,this.out_sx=1,this.out_sy=1,this.layer_type="fc",this.filters=[];for(var s=0;s<this.out_depth;s++)this.filters.push(new a(1,1,this.num_inputs));this.biases=new a(1,1,this.out_depth,.1)};_.prototype={forward:function(t,s){this.in_act=t;for(var i=new a(1,1,this.out_depth,0),e=t.w,h=0;h<this.out_depth;h++){for(var r=0,o=this.filters[h].w,n=0;n<this.num_inputs;n++)r+=e[n]*o[n];r+=this.biases.w[h],i.w[h]=r}return this.out_act=i,this.out_act},backward:function(){var t=this.in_act;t.dw=h(t.w.length);for(var s=0;s<this.out_depth;s++){for(var i=this.filters[s],e=this.out_act.dw[s],r=0;r<this.num_inputs;r++)t.dw[r]+=i.w[r]*e,i.dw[r]+=t.w[r]*e;this.biases.dw[s]+=e}},getParamsAndGrads:function(){for(var t=[],s=0;s<this.out_depth;s++)t.push({params:this.filters[s].w,grads:this.filters[s].dw,decay_mul:this.decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,decay_mul:0}),t},toJSON:function(){var t={};t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.num_inputs=this.num_inputs,t.decay_mul=this.decay_mul,t.filters=[];for(var s=0;s<this.filters.length;s++)t.filters.push(this.filters[s].toJSON());return t.biases=this.biases.toJSON(),t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.num_inputs=t.num_inputs,this.decay_mul="undefined"!=typeof t.decay_mul?t.decay_mul:1,this.filters=[];for(var s=0;s<t.filters.length;s++){var i=new a(0,0,0,0);i.fromJSON(t.filters[s]),this.filters.push(i)}this.biases=new a(0,0,0,0),this.biases.fromJSON(t.biases)}};var d=function(t){var t=t||{};this.out_sx="undefined"!=typeof t.out_sx?t.out_sx:t.in_sx,this.out_sy="undefined"!=typeof t.out_sy?t.out_sy:t.in_sy,this.out_depth="undefined"!=typeof t.out_depth?t.out_depth:t.in_depth,this.layer_type="input"};d.prototype={forward:function(t,s){return this.in_act=t,this.out_act=t,this.out_act},backward:function(){},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type}};var p=function(t){var t=t||{};this.k=t.k,this.n=t.n,this.alpha=t.alpha,this.beta=t.beta,this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="lrn",this.n%2===0&&console.log("WARNING n should be odd for LRN layer")};p.prototype={forward:function(t,s){this.in_act=t;var i=t.cloneAndZero();this.S_cache_=t.cloneAndZero();for(var e=Math.floor(this.n/2),h=0;h<t.sx;h++)for(var r=0;r<t.sy;r++)for(var o=0;o<t.depth;o++){for(var a=t.get(h,r,o),n=0,u=Math.max(0,o-e);u<=Math.min(o+e,t.depth-1);u++){var _=t.get(h,r,u);n+=_*_}n*=this.alpha/this.n,n+=this.k,this.S_cache_.set(h,r,o,n),n=Math.pow(n,this.beta),i.set(h,r,o,a/n)}return this.out_act=i,this.out_act},backward:function(){var t=this.in_act;t.dw=h(t.w.length);for(var s=(this.out_act,Math.floor(this.n/2)),i=0;i<t.sx;i++)for(var e=0;e<t.sy;e++)for(var r=0;r<t.depth;r++)for(var o=this.out_act.get_grad(i,e,r),a=this.S_cache_.get(i,e,r),n=Math.pow(a,this.beta),u=n*n,_=Math.max(0,r-s);_<=Math.min(r+s,t.depth-1);_++){var d=t.get(i,e,_),p=-d*this.beta*Math.pow(a,this.beta-1)*this.alpha/this.n*2*d;_===r&&(p+=n),p/=u,p*=o,t.add_grad(i,e,_,p)}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.k=this.k,t.n=this.n,t.alpha=this.alpha,t.beta=this.beta,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.out_depth=this.out_depth,t.layer_type=this.layer_type,t},fromJSON:function(t){this.k=t.k,this.n=t.n,this.alpha=t.alpha,this.beta=t.beta,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.out_depth=t.out_depth,this.layer_type=t.layer_type}};var f=function(t){var t=t||{};this.num_inputs=t.in_sx*t.in_sy*t.in_depth,this.out_depth=this.num_inputs,this.out_sx=1,this.out_sy=1,this.layer_type="softmax"};f.prototype={forward:function(t,s){this.in_act=t;for(var i=new a(1,1,this.out_depth,0),e=t.w,r=t.w[0],o=1;o<this.out_depth;o++)e[o]>r&&(r=e[o]);for(var n=h(this.out_depth),u=0,o=0;o<this.out_depth;o++){var _=Math.exp(e[o]-r);u+=_,n[o]=_}for(var o=0;o<this.out_depth;o++)n[o]/=u,i.w[o]=n[o];return this.es=n,this.out_act=i,this.out_act},backward:function(t){var s=this.in_act;s.dw=h(s.w.length);for(var i=0;i<this.out_depth;i++){var e=i===t?1:0,r=-(e-this.es[i]);s.dw[i]=r}return-Math.log(this.es[t])},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.num_inputs=this.num_inputs,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.num_inputs=t.num_inputs}};var y=function(t){var t=t||{};this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="dropout",this.drop_prob="undefined"!=typeof t.drop_prob?t.drop_prob:.5,this.dropped=h(this.out_sx*this.out_sy*this.out_depth)};y.prototype={forward:function(t,s){this.in_act=t,"undefined"==typeof s&&(s=!1);var i=t.clone(),e=t.w.length;if(s)for(var h=0;h<e;h++)Math.random()<this.drop_prob?(i.w[h]=0,this.dropped[h]=!0):this.dropped[h]=!1;else for(var h=0;h<e;h++)i.w[h]*=this.drop_prob;return this.out_act=i,this.out_act},backward:function(){var t=this.in_act,s=this.out_act,i=t.w.length;t.dw=h(i);for(var e=0;e<i;e++)this.dropped[e]||(t.dw[e]=s.dw[e])},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.drop_prob=this.drop_prob,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.drop_prob=t.drop_prob}};var l=function(t){var t=t||{};this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="relu"};l.prototype={forward:function(t,s){this.in_act=t;for(var i=t.clone(),e=t.w.length,h=i.w,r=0;r<e;r++)h[r]<0&&(h[r]=0);return this.out_act=i,this.out_act},backward:function(){var t=this.in_act,s=this.out_act,i=t.w.length;t.dw=h(i);for(var e=0;e<i;e++)s.w[e]<=0?t.dw[e]=0:t.dw[e]=s.dw[e]},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type}};var c=function(t){this.layers=[]};c.prototype={makeLayers:function(t){t.length<2&&console.log("ERROR! For now at least have input and softmax layers."),"input"!==t[0].type&&console.log("ERROR! For now first layer should be input."),"softmax"!==t[t.length-1].type&&console.log("ERROR! For now last layer should be softmax.");var s=function(){for(var s=[],i=0;i<t.length;i++){var e=t[i];"softmax"===e.type&&s.push({type:"fc",num_neurons:e.num_classes}),s.push(e),"undefined"!=typeof e.activation&&("relu"===e.activation?s.push({type:"relu"}):console.log("ERROR unsupported activation "+e.activation)),"undefined"!=typeof e.drop_prob&&"dropout"!==e.type&&s.push({type:"dropout",drop_prob:e.drop_prob})}return s};t=s(t),this.layers=[];for(var i=0;i<t.length;i++){var e=t[i];switch(i>0&&(prev=this.layers[i-1],e.in_sx=prev.out_sx,e.in_sy=prev.out_sy,e.in_depth=prev.out_depth),e.type){case"fc":this.layers.push(new _(e));break;case"lrn":this.layers.push(new p(e));break;case"dropout":this.layers.push(new y(e));break;case"input":this.layers.push(new d(e));break;case"softmax":this.layers.push(new f(e));break;case"conv":this.layers.push(new n(e));break;case"pool":this.layers.push(new u(e));break;case"relu":this.layers.push(new l(e));break;default:console.log("ERROR: UNRECOGNIZED LAYER TYPE!")}}},forward:function(t,s){"undefined"==typeof s&&(s=!1);for(var i=this.layers[0].forward(t,s),e=1;e<this.layers.length;e++)i=this.layers[e].forward(i,s);return i},backward:function(t){for(var s=this.layers.length,i=this.layers[s-1].backward(t),e=s-2;e>=0;e--)this.layers[e].backward();return i},getParamsAndGrads:function(){for(var t=[],s=0;s<this.layers.length;s++)for(var i=this.layers[s].getParamsAndGrads(),e=0;e<i.length;e++)t.push(i[e]);return t},getPrediction:function(){for(var t=this.layers[this.layers.length-1],s=t.out_act.w,i=s[0],e=0,h=1;h<s.length;h++)s[h]>i&&(i=s[h],e=h);return e},toJSON:function(){var t={};t.layers=[];for(var s=0;s<this.layers.length;s++)t.layers.push(this.layers[s].toJSON());return t},fromJSON:function(t){this.layers=[];for(var s=0;s<t.layers.length;s++){var i,e=t.layers[s],h=e.layer_type;"input"===h&&(i=new d),"relu"===h&&(i=new l),"dropout"===h&&(i=new y),"conv"===h&&(i=new n),"pool"===h&&(i=new u),"lrn"===h&&(i=new p),"softmax"===h&&(i=new f),"fc"===h&&(i=new _),i.fromJSON(e),this.layers.push(i)}}};var w=function(t,s){this.net=t;var s=s||{};this.learning_rate=s.learning_rate||.01,this.decay=s.decay||.001,this.batch_size=s.batch_size||1,this.momenum=.9,"undefined"!=typeof s.momentum&&(this.momentum=s.momentum),this.k=0,this.last_gs=[]};return w.prototype={train:function(t,s){var i=(new Date).getTime();this.net.forward(t,!0);var e=(new Date).getTime(),r=e-i,i=(new Date).getTime(),o=this.net.backward(s),a=0,e=(new Date).getTime(),n=e-i;if(this.k++,this.k%this.batch_size===0){var u=this.net.getParamsAndGrads();if(0===this.last_gs.length&&this.momentum>0)for(var _=0;_<u.length;_++)this.last_gs.push(h(u[_].params.length));for(var _=0;_<u.length;_++)for(var d=u[_],p=d.params,f=d.grads,y="undefined"!=typeof d.decay_mul?d.decay_mul:1,l=this.decay*y,c=0;c<p.length;c++){if(a+=l*p[c]*p[c]/2,this.momentum>0){var w=-this.learning_rate*(l*p[c]+f[c])/this.batch_size,v=this.momentum*this.last_gs[_][c]+(1-this.momentum)*w;p[c]+=v,this.last_gs[_][c]=v}else p[c]-=this.learning_rate*(l*p[c]+f[c])/this.batch_size;f[c]=0}}return{fwd_time:r,bwd_time:n,softmax_loss:o,decay_loss:a,loss:o+a}}},t=t||{},t.Net=c,t.ReluLayer=l,t.InputLayer=d,t.ConvLayer=n,t.PoolLayer=u,t.SoftmaxLayer=f,t.DropoutLayer=y,t.LocalResponseNormalizationLayer=p,t.FullyConnLayer=_,t.Vol=a,t.SGDTrainer=w,t.augment=r,t.zeros=h,t.img_to_vol=o,t}("undefined"!=typeof module&&module.exports);