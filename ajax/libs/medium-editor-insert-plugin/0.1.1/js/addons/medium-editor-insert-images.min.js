/*! 
 * medium-editor-insert-plugin v0.1.1 - jQuery insert plugin for MediumEditor
 *
 * Images Addon
 *
 * https://github.com/orthes/medium-editor-images-plugin
 * 
 * Copyright (c) 2013 Pavel Linkesch (http://linkesch.sk)
 * Released under the MIT license
 */
!function(a){a.fn.mediumInsert.images={init:function(){this.$el=a.fn.mediumInsert.insert.$el,this.setImageEvents(),this.setDragAndDropEvents()},add:function(b){var c,d,e=this;return c=a('<input type="file">').click(),c.change(function(){d=this.files,e.uploadFiles(b,d)}),a.fn.mediumInsert.insert.deselect(),c},updateProgressBar:function(b){var c,d=a(".progress:first",this.$el);b.lengthComputable&&(c=b.loaded/b.total*100|0,d.attr("value",c),d.html(c))},uploadCompleted:function(b){var c,d=a(".progress:first",this.$el);d.attr("value",100),d.html(100),d.before('<span class="mediumInsert-images"><img src="'+b.currentTarget.response+'" draggable="true" alt=""></span>'),c=d.siblings("img"),d.remove(),c.load(function(){c.parent().mouseleave().mouseenter()})},uploadFiles:function(b,c){for(var d={"image/png":!0,"image/jpeg":!0,"image/gif":!0},e=0;e<c.length;e++){var f=c[e];if(d[f.type]===!0){var g=new FormData;g.append("file",f),b.append('<progress class="progress" min="0" max="100" value="0">0</progress>');var h=new XMLHttpRequest;h.open("POST",a.fn.mediumInsert.settings.imagesUploadScript),h.send(g),h.upload.onprogress=this.updateProgressBar,h.onload=this.uploadCompleted}}},setImageEvents:function(){this.$el.on("mouseenter",".mediumInsert-images",function(){var b,c,d=a("img",this);d.length>0&&(a(this).append('<a class="mediumInsert-imageRemove"></a>'),a(this).parent().parent().hasClass("small")?a(this).append('<a class="mediumInsert-imageResizeBigger"></a>'):a(this).append('<a class="mediumInsert-imageResizeSmaller"></a>'),b=d.position().top+parseInt(d.css("margin-top"),10),c=d.position().left+d.width()-30,a(".mediumInsert-imageRemove",this).css({right:"auto",top:b,left:c}),a(".mediumInsert-imageResizeBigger, .mediumInsert-imageResizeSmaller",this).css({right:"auto",top:b,left:c-31}))}),this.$el.on("mouseleave",".mediumInsert-images",function(){a(".mediumInsert-imageRemove, .mediumInsert-imageResizeSmaller, .mediumInsert-imageResizeBigger",this).remove()}),this.$el.on("click",".mediumInsert-imageResizeSmaller",function(){a(this).parent().parent().parent().addClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageResizeBigger",function(){a(this).parent().parent().parent().removeClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageRemove",function(){0===a(this).parent().siblings().length&&a(this).parent().parent().parent().removeClass("small"),a(this).parent().remove(),a.fn.mediumInsert.insert.deselect()})},setDragAndDropEvents:function(){var b,c,d=this,e=!1,f=!1;a(document).on("dragover","body",function(){a(this).addClass("hover")}),a(document).on("dragend","body",function(){a(this).removeClass("hover")}),this.$el.on("dragover",".mediumInsert",function(){a(this).addClass("hover"),a(this).attr("contenteditable",!0)}),this.$el.on("dragleave",".mediumInsert",function(){a(this).removeClass("hover"),a(this).attr("contenteditable",!1)}),this.$el.on("dragstart",".mediumInsert .mediumInsert-images img",function(){b=a(this).parent().index(),c=a(this).parent().parent().parent().attr("id")}),this.$el.on("dragend",".mediumInsert .mediumInsert-images img",function(b){e===!0&&(0===a(b.originalEvent.target.parentNode).siblings().length&&a(b.originalEvent.target.parentNode).parent().parent().removeClass("small"),a(b.originalEvent.target.parentNode).mouseleave(),a(b.originalEvent.target.parentNode).remove(),e=!1,f=!1)}),this.$el.on("dragover",".mediumInsert .mediumInsert-images img",function(a){a.preventDefault()}),this.$el.on("drop",".mediumInsert .mediumInsert-images img",function(){var d,e,g;return c!==a(this).parent().parent().parent().attr("id")?(f=!1,b=c=null,void 0):(d=parseInt(b,10),e=a(this).parent().parent().find(".mediumInsert-images:nth-child("+(d+1)+")"),g=a(this).parent().index(),g>d?e.insertAfter(a(this).parent()):d>g&&e.insertBefore(a(this).parent()),e.mouseleave(),f=!0,b=null,void 0)}),this.$el.on("drop",".mediumInsert",function(b){var c;b.preventDefault(),a(this).removeClass("hover"),a("body").removeClass("hover"),a(this).attr("contenteditable",!1),c=b.originalEvent.dataTransfer.files,c.length>0?d.uploadFiles(a(".mediumInsert-placeholder",this),c):f===!0?f=!1:(a(".mediumInsert-placeholder",this).append('<span class="mediumInsert-images">'+b.originalEvent.dataTransfer.getData("text/html")+"</span>"),a("meta",this).remove(),e=!0)})}}}(jQuery);