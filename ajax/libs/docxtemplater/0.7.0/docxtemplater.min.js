var DocUtils,DocXTemplater,DocxGen,ImgManager,JSZip,env,fs;env="undefined"!=typeof global&&null!==global?"node":"browser",DocUtils=require("./docUtils"),ImgManager=require("./imgManager"),DocXTemplater=require("./docxTemplater"),"node"===env&&(fs=require("fs"),JSZip=require("jszip")),module.exports=DocxGen=function(){function t(t,e,n){this.Tags=null!=e?e:{},this.options=n,this.setOptions(this.options),this.finishedCallback=function(){},this.filesProcessed=0,this.qrCodeNumCallBack=0,this.qrCodeWaitingFor=[],null!=t&&t.length>0&&this.load(t)}var e;return e=["word/document.xml","word/footer1.xml","word/footer2.xml","word/footer3.xml","word/header1.xml","word/header2.xml","word/header3.xml"],t.prototype.setOptions=function(t){return this.options=t,null!=this.options&&(this.intelligentTagging=null==this.options.intelligentTagging||this.options.intelligentTagging,this.qrCode=null!=this.options.qrCode&&DocUtils.unsecureQrCode,null!=this.options.parser&&(this.parser=t.parser)),this},t.prototype.loadFromFile=function(t,e){var n;return null==e&&(e={}),this.setOptions(e),n={success:function(t){return this.successFun=t},successFun:function(){}},null==e.docx&&(e.docx=!1),null==e.async&&(e.async=!1),null==e.callback&&(e.callback=function(t){return function(e){return t.load(e),n.successFun(t)}}(this)),DocUtils.loadDoc(t,e),e.async===!1?this:n},t.prototype.qrCodeCallBack=function(t,e){var n;return null==e&&(e=!0),e===!0?this.qrCodeWaitingFor.push(t):e===!1&&(n=this.qrCodeWaitingFor.indexOf(t),this.qrCodeWaitingFor.splice(n,1)),this.testReady()},t.prototype.testReady=function(){if(0===this.qrCodeWaitingFor.length&&this.filesProcessed===e.length)return this.ready=!0,this.finishedCallback()},t.prototype.getImageList=function(){return this.imgManager.getImageList()},t.prototype.setImage=function(t,e,n){return null==n&&(n={}),null==n.binary&&(n.binary=!0),this.imgManager.setImage(t,e,n)},t.prototype.load=function(t){return this.loadedContent=t,this.zip=new JSZip(t),this.imgManager=new ImgManager(this.zip).loadImageRels(),this},t.prototype.applyTags=function(t,n){var i,o,s,l,r,a;for(this.Tags=null!=t?t:this.Tags,null==n&&(n=null),s=0,r=e.length;s<r;s++)o=e[s],null==this.zip.files[o]&&this.filesProcessed++;for(l=0,a=e.length;l<a;l++)o=e[l],null!=this.zip.files[o]&&(i=new DocXTemplater(this.zip.files[o].asText(),{DocxGen:this,Tags:this.Tags,intelligentTagging:this.intelligentTagging,qrCodeCallback:n,parser:this.parser}),this.setData(o,i.applyTags().content),this.filesProcessed++);return this.testReady()},t.prototype.setData=function(t,e,n){return null==n&&(n={}),this.zip.remove(t),this.zip.file(t,e,n)},t.prototype.getTags=function(){var t,n,i,o,s,l;for(i=[],s=0,l=e.length;s<l;s++)n=e[s],null!=this.zip.files[n]&&(t=new DocXTemplater(this.zip.files[n].asText(),{DocxGen:this,Tags:this.Tags,intelligentTagging:this.intelligentTagging,parser:this.parser}),o=t.applyTags().usedTags,DocUtils.sizeOfObject(o)&&i.push({fileName:n,vars:o}));return i},t.prototype.setTags=function(t){return this.Tags=t,this},t.prototype.output=function(t){var e;return null==t&&(t={}),null==t.download&&(t.download=!0),null==t.name&&(t.name="output.docx"),null==t.type&&(t.type="base64"),e=this.zip.generate({type:t.type}),t.download&&("node"===env?fs.writeFile(process.cwd()+"/"+t.name,e,"base64",function(e){if(e)throw e;if(null!=t.callback)return t.callback()}):document.location.href="data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,"+e),e},t.prototype.getFullText=function(t){var e;return null==t&&(t="word/document.xml"),e=this.zip.files[t].asText(),new DocXTemplater(e,{DocxGen:this,Tags:this.Tags,intelligentTagging:this.intelligentTagging}).getFullText()},t.prototype.download=function(t,e,n){var i;return null==n&&(n="default.docx"),i=this.zip.generate(),Downloadify.create("downloadify",{filename:function(){return n},data:function(){return i},onCancel:function(){return alert("You have cancelled the saving of this file.")},onError:function(){return alert("You must put something in the File Contents or there will be nothing to save!")},swf:t,downloadImage:e,width:100,height:30,transparent:!0,append:!1,dataType:"base64"})},t}();